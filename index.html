<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Wine Cellar">
    <meta name="theme-color" content="#722f37">
    <title>Wine Cellar Tracker</title>
    <style>
        :root {
            --color-primary: #722f37;
            --color-primary-hover: #8b3a45;
            --color-surface: #f5f1e8;
            --color-text: #2c2416;
            --color-border: #d4ccc0;
            --color-success: #2d8659;
            --color-error: #c01530;
            --color-warn: #a84f2f;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--color-surface);
            color: var(--color-text);
            padding: 16px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 32px;
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 16px;
        }

        h1 {
            font-size: 28px;
            color: var(--color-primary);
            margin-bottom: 8px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .stat-box {
            background: white;
            padding: 12px 24px;
            border-radius: 8px;
            border: 1px solid var(--color-border);
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--color-primary);
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        @media (max-width: 768px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: white;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 20px;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--color-primary);
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 8px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 6px;
            color: var(--color-text);
        }

        input[type="text"],
        input[type="number"],
        input[type="file"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            color: var(--color-text);
            background: white;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 250ms ease;
            text-align: center;
            display: inline-block;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-secondary {
            background: #f0ece3;
            color: var(--color-primary);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover {
            background: #e8dfd4;
        }

        .btn-danger {
            background: var(--color-error);
            color: white;
            font-size: 12px;
            padding: 6px 12px;
        }

        .btn-danger:hover {
            background: #a01225;
        }

        .btn-success {
            background: var(--color-success);
            color: white;
        }

        .btn-success:hover {
            background: #1f5f3f;
        }

        .photo-preview {
            margin-top: 10px;
            position: relative;
        }

        .photo-preview img {
            max-width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid var(--color-border);
        }

        .wine-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        .wine-card {
            background: white;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            overflow: hidden;
            transition: box-shadow 250ms ease;
        }

        .wine-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .wine-image {
            width: 100%;
            height: 160px;
            background: #eee;
            object-fit: cover;
            border-bottom: 1px solid var(--color-border);
        }

        .wine-info {
            padding: 12px;
        }

        .wine-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 6px;
            color: var(--color-primary);
        }

        .wine-detail {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .wine-actions {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }

        .wine-actions button {
            flex: 1;
            padding: 6px 10px;
            font-size: 11px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 250ms ease;
        }

        .btn-drink {
            background: var(--color-success);
            color: white;
        }

        .btn-drink:hover {
            background: #1f5f3f;
        }

        .btn-delete {
            background: #f0ece3;
            color: var(--color-error);
            border: 1px solid var(--color-border);
        }

        .btn-delete:hover {
            background: #e8ddf0;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            border-bottom: 2px solid var(--color-border);
        }

        .tab {
            padding: 10px 16px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #999;
            font-size: 14px;
            border-bottom: 3px solid transparent;
            transition: all 250ms ease;
        }

        .tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .voice-recorder {
            background: #f9f6f0;
            border: 2px dashed var(--color-primary);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            margin-top: 10px;
        }

        .recording-indicator {
            color: var(--color-error);
            font-weight: 600;
            margin-top: 8px;
        }

        .voice-list {
            margin-top: 12px;
        }

        .voice-item {
            background: #f9f6f0;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .voice-time {
            font-size: 12px;
            color: #999;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--color-primary);
        }

        .modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .tasting-notes {
            background: #f9f6f0;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 13px;
            line-height: 1.5;
        }

        .price-badge {
            background: var(--color-warn);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stats-card {
            background: linear-gradient(135deg, #f9f6f0 0%, #f5f1e8 100%);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--color-border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .stats-card-title {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .stats-card-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--color-primary);
            margin-bottom: 4px;
        }

        .stats-card-subtitle {
            font-size: 12px;
            color: #666;
        }

        .chart-container {
            background: white;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 16px;
            margin-top: 24px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üçá –ú–æ–π –≤–∏–Ω–Ω—ã–π –ø–æ–≥—Ä–µ–±</h1>
            <p>–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –∏ –∑–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ —Å–≤–æ—é –∫–æ–ª–ª–µ–∫—Ü–∏—é –≤–∏–Ω</p>
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-label">–í—Å–µ–≥–æ –±—É—Ç—ã–ª–æ–∫ –≤ –Ω–∞–ª–∏—á–∏–∏</div>
                    <div class="stat-value" id="totalWines">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –≤ –Ω–∞–ª–∏—á–∏–∏</div>
                    <div class="stat-value" id="totalWinesPrice">0‚ÇΩ</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">–í—ã–ø–∏—Ç–æ (–≤—Å–µ–≥–æ)</div>
                    <div class="stat-value" id="totalDrunk">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">–í—ã–ø–∏—Ç–æ (—Å—Ç–æ–∏–º–æ—Å—Ç—å)</div>
                    <div class="stat-value" id="totalDrunkPrice">0‚ÇΩ</div>
                </div>
            </div>
        </header>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ã–ø–∏—Ç–æ–≥–æ –ø–æ –º–µ—Å—è—Ü–∞–º -->
        <div class="stats-grid">
            <div class="stats-card">
                <div class="stats-card-title">–í—ã–ø–∏—Ç–æ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ</div>
                <div class="stats-card-value" id="monthBottles">0</div>
                <div class="stats-card-subtitle">–±—É—Ç—ã–ª–æ–∫</div>
            </div>
            <div class="stats-card">
                <div class="stats-card-title">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ</div>
                <div class="stats-card-value" id="monthCost">0‚ÇΩ</div>
                <div class="stats-card-subtitle">–Ω–∞ –≤—ã–ø–∏—Ç–æ–µ –≤–∏–Ω–æ</div>
            </div>
            <div class="stats-card">
                <div class="stats-card-title">–°—Ä–µ–¥–Ω–µ–µ –∑–∞ –º–µ—Å—è—Ü</div>
                <div class="stats-card-value" id="avgCost">0‚ÇΩ</div>
                <div class="stats-card-subtitle">—Å—Ä–µ–¥–Ω–µ–µ —Ä–∞—Å—Ö–æ–¥–æ–≤–∞–Ω–∏–µ</div>
            </div>
            <div class="stats-card">
                <div class="stats-card-title">–°–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π –º–µ—Å—è—Ü</div>
                <div class="stats-card-value" id="topMonth">‚Äî</div>
                <div class="stats-card-subtitle">–ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –±—É—Ç—ã–ª–æ–∫</div>
            </div>
        </div>

        <!-- –î–∏–∞–≥—Ä–∞–º–º–∞ –≤—ã–ø–∏—Ç–æ–≥–æ –ø–æ –º–µ—Å—è—Ü–∞–º -->
        <div class="chart-container">
            <div class="chart-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 –º–µ—Å—è—Ü–µ–≤)</div>
            <canvas id="monthlyChart" style="max-height: 300px;"></canvas>
        </div>

        <div class="main-layout">
            <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–∏–Ω–∞ -->
            <div class="panel">
                <div class="panel-title">–î–æ–±–∞–≤–∏—Ç—å –≤–∏–Ω–æ</div>
                
                <form id="addWineForm">
                    <div class="form-group">
                        <label>–§–æ—Ç–æ —ç—Ç–∏–∫–µ—Ç–∫–∏</label>
                        <input type="file" id="winePhoto" accept="image/*" capture="environment">
                        <div class="photo-preview" id="photoPreview"></div>
                    </div>

                    <div class="form-group">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–Ω–∞</label>
                        <input type="text" id="wineName" placeholder="–ù–∞–ø—Ä. Pinot Noir 2018" required>
                    </div>

                    <div class="form-group">
                        <label>–°—Ç—Ä–∞–Ω–∞/–†–µ–≥–∏–æ–Ω</label>
                        <input type="text" id="wineRegion" placeholder="–ù–∞–ø—Ä. –§—Ä–∞–Ω—Ü–∏—è, –ë—É—Ä–≥—É–Ω–¥–∏—è">
                    </div>

                    <div class="form-group">
                        <label>–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–∫—É–ø–∫–∏ (‚ÇΩ)</label>
                        <input type="number" id="winePrice" placeholder="2500" min="0">
                    </div>

                    <div class="form-group">
                        <label>–ì–¥–µ –∫—É–ø–ª–µ–Ω–æ</label>
                        <input type="text" id="wineBought" placeholder="–ù–∞–ø—Ä. –í–∏–Ω–æ—Ç–µ–∫–∞ –Ω–∞ –ê—Ä–±–∞—Ç–µ">
                    </div>

                    <div class="form-group">
                        <label>–ó–∞–º–µ—Ç–∫–∏</label>
                        <textarea id="wineNotes" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∏–Ω–µ..."></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ–≥—Ä–µ–±</button>
                </form>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: –∫–æ–ª–ª–µ–∫—Ü–∏—è –≤–∏–Ω -->
            <div class="panel">
                <div class="panel-title">–ú–æ—è –∫–æ–ª–ª–µ–∫—Ü–∏—è</div>
                
                <div class="tabs">
                    <button class="tab active" data-tab="available">–ò–º–µ–µ—Ç—Å—è (–í –Ω–∞–ª–∏—á–∏–∏)</button>
                    <button class="tab" data-tab="drunk">–í—ã–ø–∏—Ç–æ (–ó–∞–º–µ—Ç–∫–∏)</button>
                </div>

                <div id="available" class="tab-content active">
                    <div class="wine-grid" id="wineGrid">
                        <div class="empty-state">
                            <div class="empty-state-icon">üç∑</div>
                            <p>–ü–æ–≥—Ä–µ–± –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ –≤–∏–Ω–æ!</p>
                        </div>
                    </div>
                </div>

                <div id="drunk" class="tab-content">
                    <div id="drunkList">
                        <div class="empty-state">
                            <div class="empty-state-icon">‚úì</div>
                            <p>–í—ã –µ—â–µ –Ω–µ –ø—Ä–æ–±–æ–≤–∞–ª–∏ –≤–∏–Ω–∞ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–π -->
    <div id="drinkModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeDrinkModal()">‚úï</button>
            <div class="modal-header">–ú–æ–∏ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è –æ –≤–∏–Ω–µ</div>
            
            <div id="currentWineInfo" style="margin-bottom: 16px;"></div>

            <div class="form-group">
                <label>–†–µ–π—Ç–∏–Ω–≥ (1-10)</label>
                <input type="number" id="drinkRating" min="1" max="10" placeholder="7">
            </div>

            <div class="form-group">
                <label>–ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
                <div class="voice-recorder">
                    <button type="button" class="btn btn-secondary" id="recordBtn" onclick="toggleRecord()">
                        üé§ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å
                    </button>
                    <div class="recording-indicator" id="recordingStatus"></div>
                </div>
                <div class="voice-list" id="voiceList"></div>
            </div>

            <div class="form-group">
                <label>–ò–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –∑–∞–º–µ—Ç–∫—É</label>
                <textarea id="drinkNotes" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –≤–∫—É—Å–∞, –∞—Ä–æ–º–∞—Ç–∞, –ø–∏—â–µ–≤—ã—Ö –ø–∞—Ä..."></textarea>
            </div>

            <button type="button" class="btn btn-success" onclick="saveDrinkRecord()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è</button>
            <button type="button" class="btn btn-secondary" onclick="closeDrinkModal()" style="margin-top: 8px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script>
        let wines = JSON.parse(localStorage.getItem('wines')) || [];
        let drunkWines = JSON.parse(localStorage.getItem('drunkWines')) || [];
        let mediaRecorder;
        let audioChunks = [];
        let currentWineId = null;
        let isRecording = false;
        let monthlyChart = null;

        // === –£–ü–†–ê–í–õ–ï–ù–ò–ï –í–ò–ù–û–ú ===

        document.getElementById('addWineForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('wineName').value.trim();
            const region = document.getElementById('wineRegion').value.trim();
            const price = document.getElementById('winePrice').value.trim();
            const bought = document.getElementById('wineBought').value.trim();
            const notes = document.getElementById('wineNotes').value.trim();
            const photo = document.getElementById('winePhoto').files[0];

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–ª—è
            if (!name) {
                alert('‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∏–Ω–∞');
                return;
            }

            // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–∏–Ω–∞
            const saveWine = (photoData) => {
                const wine = {
                    id: Date.now(),
                    name: name,
                    region: region,
                    price: price,
                    bought: bought,
                    notes: notes,
                    photo: photoData,
                    dateAdded: new Date().toLocaleDateString('ru-RU')
                };

                wines.push(wine);
                localStorage.setItem('wines', JSON.stringify(wines));
                document.getElementById('addWineForm').reset();
                document.getElementById('photoPreview').innerHTML = '';
                renderWines();
                updateStats();
                alert('‚úì –í–∏–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –ø–æ–≥—Ä–µ–±!');
            };

            // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ, –∑–∞–≥—Ä—É–∑–∏—Ç—å –µ–≥–æ
            if (photo) {
                const reader = new FileReader();
                reader.onerror = function() {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ');
                };
                reader.onload = function(e) {
                    saveWine(e.target.result);
                };
                reader.readAsDataURL(photo);
            } else {
                // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–µ–∑ —Ñ–æ—Ç–æ
                saveWine(null);
            }
        });

        document.getElementById('winePhoto').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('photoPreview').innerHTML = 
                        `<img src="${e.target.result}" alt="Preview">`;
                };
                reader.readAsDataURL(file);
            }
        });

        function renderWines() {
            const grid = document.getElementById('wineGrid');
            
            if (wines.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üç∑</div>
                        <p>–ü–æ–≥—Ä–µ–± –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ –≤–∏–Ω–æ!</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = wines.map(wine => `
                <div class="wine-card">
                    ${wine.photo ? `<img src="${wine.photo}" class="wine-image">` : 
                      `<div class="wine-image" style="display: flex; align-items: center; justify-content: center; background: #f0ece3;">üç∑</div>`}
                    <div class="wine-info">
                        <div class="wine-name">${wine.name}</div>
                        <div class="wine-detail">üìç ${wine.region || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                        ${wine.price ? `<div class="wine-detail"><span class="price-badge">${wine.price}‚ÇΩ</span></div>` : ''}
                        ${wine.bought ? `<div class="wine-detail">üè™ ${wine.bought}</div>` : ''}
                        <div class="wine-detail" style="font-size: 11px; color: #999; margin-top: 6px;">–î–æ–±–∞–≤–ª–µ–Ω–æ: ${wine.dateAdded}</div>
                        <div class="wine-actions">
                            <button class="btn-drink" onclick="openDrinkModal(${wine.id})">–í—ã–ø–∏—Ç—å</button>
                            <button class="btn-delete" onclick="deleteWine(${wine.id})">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function deleteWine(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –≤–∏–Ω–æ –∏–∑ –ø–æ–≥—Ä–µ–±–∞?')) {
                wines = wines.filter(w => w.id !== id);
                localStorage.setItem('wines', JSON.stringify(wines));
                renderWines();
                updateStats();
            }
        }

        // === –ó–ê–ü–ò–°–¨ –í–ü–ï–ß–ê–¢–õ–ï–ù–ò–ô ===

        function openDrinkModal(id) {
            currentWineId = id;
            const wine = wines.find(w => w.id === id);
            
            document.getElementById('currentWineInfo').innerHTML = `
                <div style="background: #f9f6f0; padding: 12px; border-radius: 6px; border-left: 4px solid var(--color-primary);">
                    <strong>${wine.name}</strong><br>
                    <small style="color: #666;">${wine.region || ''}</small>
                </div>
            `;

            document.getElementById('drinkRating').value = '';
            document.getElementById('drinkNotes').value = '';
            audioChunks = [];
            document.getElementById('voiceList').innerHTML = '';
            document.getElementById('recordingStatus').innerHTML = '';
            document.getElementById('recordBtn').textContent = 'üé§ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å';
            isRecording = false;

            document.getElementById('drinkModal').classList.add('show');
        }

        function closeDrinkModal() {
            document.getElementById('drinkModal').classList.remove('show');
            if (isRecording) toggleRecord();
        }

        // === –ì–û–õ–û–°–û–í–ê–Ø –ó–ê–ü–ò–°–¨ ===

        async function toggleRecord() {
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        
                        const voiceList = document.getElementById('voiceList');
                        const voiceItem = document.createElement('div');
                        voiceItem.className = 'voice-item';
                        voiceItem.innerHTML = `
                            <div>
                                <audio controls style="height: 24px; max-width: 200px;">
                                    <source src="${audioUrl}" type="audio/webm">
                                </audio>
                                <div class="voice-time">${new Date().toLocaleTimeString('ru-RU')}</div>
                            </div>
                            <button type="button" class="btn-delete" onclick="this.parentElement.remove()">‚úï</button>
                        `;
                        voiceList.appendChild(voiceItem);
                        
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    document.getElementById('recordBtn').textContent = '‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å';
                    document.getElementById('recordingStatus').textContent = 'üî¥ –ò–¥–µ—Ç –∑–∞–ø–∏—Å—å...';
                } catch (error) {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞.');
                    console.error('–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞:', error);
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                document.getElementById('recordBtn').textContent = 'üé§ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å';
                document.getElementById('recordingStatus').textContent = '';
            }
        }

        function saveDrinkRecord() {
            const wine = wines.find(w => w.id === currentWineId);
            const rating = document.getElementById('drinkRating').value;
            const notes = document.getElementById('drinkNotes').value;
            const voiceItems = document.getElementById('voiceList').querySelectorAll('.voice-item');

            const record = {
                id: Date.now(),
                wineId: currentWineId,
                wineName: wine.name,
                winePrice: wine.price,
                rating: rating || '–ù–µ –æ—Ü–µ–Ω–µ–Ω–æ',
                notes: notes,
                voiceCount: voiceItems.length,
                dateTasted: new Date().toLocaleDateString('ru-RU')
            };

            drunkWines.push(record);
            localStorage.setItem('drunkWines', JSON.stringify(drunkWines));
            
            wines = wines.filter(w => w.id !== currentWineId);
            localStorage.setItem('wines', JSON.stringify(wines));

            renderWines();
            renderDrunkWines();
            updateStats();
            closeDrinkModal();

            alert('‚úì –í–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
        }

        function renderDrunkWines() {
            const list = document.getElementById('drunkList');
            
            if (drunkWines.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚úì</div>
                        <p>–í—ã –µ—â–µ –Ω–µ –ø—Ä–æ–±–æ–≤–∞–ª–∏ –≤–∏–Ω–∞ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = `
                <div style="display: grid; gap: 12px;">
                    ${drunkWines.map(record => `
                        <div style="background: white; border: 1px solid var(--color-border); border-radius: 8px; padding: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                <div>
                                    <div style="font-weight: 600; color: var(--color-primary); margin-bottom: 4px;">${record.wineName}</div>
                                    <div style="font-size: 12px; color: #666;">–ü–æ–ø—Ä–æ–±–æ–≤–∞–Ω–æ: ${record.dateTasted}</div>
                                </div>
                                <button class="btn-delete" onclick="deleteDrunkWine(${record.id})">‚úï</button>
                            </div>
                            ${record.rating !== '–ù–µ –æ—Ü–µ–Ω–µ–Ω–æ' ? `<div style="margin: 8px 0;"><strong>–†–µ–π—Ç–∏–Ω–≥:</strong> ‚≠ê ${record.rating}/10</div>` : ''}
                            ${record.price ? `<div style="font-size: 12px; color: #666;"><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> ${record.price}‚ÇΩ</div>` : ''}
                            ${record.voiceCount > 0 ? `<div style="font-size: 12px; color: var(--color-success); margin: 8px 0;"><strong>üéôÔ∏è –ì–æ–ª–æ—Å–æ–≤—ã—Ö –∑–∞–º–µ—Ç–æ–∫:</strong> ${record.voiceCount}</div>` : ''}
                            ${record.notes ? `<div class="tasting-notes"><strong>–ó–∞–º–µ—Ç–∫–∏:</strong> ${record.notes}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function deleteDrunkWine(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –æ –≤–∏–Ω–µ?')) {
                drunkWines = drunkWines.filter(w => w.id !== id);
                localStorage.setItem('drunkWines', JSON.stringify(drunkWines));
                renderDrunkWines();
                updateStats();
            }
        }

        // === –í–ö–õ–ê–î–ö–ò ===

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                document.getElementById(this.dataset.tab).classList.add('active');
            });
        });

        // === –°–¢–ê–¢–ò–°–¢–ò–ö–ê ===

        function formatPrice(price) {
            return new Intl.NumberFormat('ru-RU').format(price) + '‚ÇΩ';
        }

        function getMonthlyStats() {
            const monthlyData = {};
            const months = [];
            const currentDate = new Date();

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 –º–µ—Å—è—Ü–µ–≤
            for (let i = 11; i >= 0; i--) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                const monthKey = date.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
                const monthNum = String(date.getMonth() + 1).padStart(2, '0');
                const yearNum = date.getFullYear();
                const key = `${yearNum}-${monthNum}`;
                monthlyData[key] = { bottles: 0, cost: 0, label: monthKey };
                months.push(key);
            }

            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—ã–ø–∏—Ç–æ–µ –≤–∏–Ω–æ –ø–æ –º–µ—Å—è—Ü–∞–º
            drunkWines.forEach(record => {
                const dateParts = record.dateTasted.split('.');
                if (dateParts.length === 3) {
                    const day = parseInt(dateParts[0]);
                    const month = String(parseInt(dateParts[1])).padStart(2, '0');
                    const year = parseInt(dateParts[2]);
                    const key = `${year}-${month}`;
                    
                    if (monthlyData[key]) {
                        monthlyData[key].bottles += 1;
                        monthlyData[key].cost += parseInt(record.price) || 0;
                    }
                }
            });

            return { monthlyData, months };
        }

        function updateStats() {
            // –û–±—â–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            const totalWinesPrice = wines.reduce((sum, w) => sum + (parseInt(w.price) || 0), 0);
            const totalDrunkPrice = drunkWines.reduce((sum, w) => sum + (parseInt(w.winePrice) || 0), 0);

            document.getElementById('totalWines').textContent = wines.length;
            document.getElementById('totalWinesPrice').textContent = formatPrice(totalWinesPrice);
            document.getElementById('totalDrunk').textContent = drunkWines.length;
            document.getElementById('totalDrunkPrice').textContent = formatPrice(totalDrunkPrice);

            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º
            const { monthlyData, months } = getMonthlyStats();
            const currentDate = new Date();
            const currentMonthKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
            const currentMonthStats = monthlyData[currentMonthKey];

            document.getElementById('monthBottles').textContent = currentMonthStats.bottles;
            document.getElementById('monthCost').textContent = formatPrice(currentMonthStats.cost);

            // –°—Ä–µ–¥–Ω–µ–µ —Ä–∞—Å—Ö–æ–¥–æ–≤–∞–Ω–∏–µ
            const totalCost = Object.values(monthlyData).reduce((sum, m) => sum + m.cost, 0);
            const avgCost = Math.round(totalCost / 12);
            document.getElementById('avgCost').textContent = formatPrice(avgCost);

            // –°–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π –º–µ—Å—è—Ü
            let topMonthKey = null;
            let maxBottles = 0;
            Object.entries(monthlyData).forEach(([key, data]) => {
                if (data.bottles > maxBottles) {
                    maxBottles = data.bottles;
                    topMonthKey = key;
                }
            });
            const topMonthLabel = topMonthKey ? monthlyData[topMonthKey].label : '‚Äî';
            document.getElementById('topMonth').textContent = topMonthLabel || '‚Äî';

            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∏–∞–≥—Ä–∞–º–º—É
            updateMontlyChart(monthlyData, months);
        }

        function updateMontlyChart(monthlyData, months) {
            const labels = months.map(m => monthlyData[m].label);
            const bottlesData = months.map(m => monthlyData[m].bottles);
            const costData = months.map(m => monthlyData[m].cost);

            const ctx = document.getElementById('monthlyChart');
            if (!ctx) return;

            if (monthlyChart) {
                monthlyChart.destroy();
            }

            monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '–ë—É—Ç—ã–ª–æ–∫',
                            data: bottlesData,
                            backgroundColor: '#722f37',
                            borderColor: '#722f37',
                            borderWidth: 1,
                            yAxisID: 'y',
                            borderRadius: 6,
                            tension: 0.4
                        },
                        {
                            label: '–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)',
                            data: costData,
                            backgroundColor: '#d4ccc0',
                            borderColor: '#a84f2f',
                            borderWidth: 2,
                            yAxisID: 'y1',
                            borderRadius: 6,
                            type: 'line',
                            tension: 0.4,
                            fill: false,
                            pointBackgroundColor: '#a84f2f',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#2c2416',
                                font: { size: 12, weight: 'bold' },
                                padding: 16,
                                usePointStyle: true
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—É—Ç—ã–ª–æ–∫',
                                color: '#722f37',
                                font: { weight: 'bold' }
                            },
                            ticks: {
                                color: '#666',
                                stepSize: 1
                            },
                            grid: {
                                color: '#f0ece3'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)',
                                color: '#a84f2f',
                                font: { weight: 'bold' }
                            },
                            ticks: {
                                color: '#666'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        x: {
                            ticks: {
                                color: '#666',
                                font: { size: 11 }
                            },
                            grid: {
                                color: '#f0ece3'
                            }
                        }
                    }
                }
            });
        }

        // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===

        renderWines();
        renderDrunkWines();
        updateStats();
    </script>
</body>
</html>
